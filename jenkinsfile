pipeline {
    agent any
    environment {
        GIT_TERMINAL_PROMPT = '1'
        GIT_CURL_VERBOSE = '1'  // Enable verbose logging for curl commands
        GIT_TRACE = '1'         // Enable tracing for git operations
        GIT_HTTP_MAX_REQUESTS = '1'  // Ensure no parallel requests to GitHub
        GIT_HTTP_LOW_SPEED_LIMIT = '1000'  // Timeout if data transfer is too slow
        GIT_HTTP_LOW_SPEED_TIME = '30'  // Timeout if data transfer is slow for 30 seconds
    }
    stages {
        stage('Checkout Code') {
            steps {
                echo 'Checking out code from public GitHub repository...'
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/tifenum/SVM-VGG-ANGULAR-DOCKER']]
                ])
            }
        }
        stage('Build Frontend') {
            steps {
                script {
                    dir('front') {
                        bat 'docker build -t front .'
                    }
                }
            }
        }
        stage('Build SVM') {
            steps {
                script {
                    dir('back_SVM') {
                        bat 'docker build -t svm .'
                    }
                }
            }
        }
        
        stage('Build VGG') {
            steps {
                script {
                    dir('music_class') {
                        bat 'docker build -t vgg .'
                    }
                }
            }
        }

        stage('Deploy'){
            steps{
                 script {
                    
                        bat 'docker-compose up -d'
                    
                }
            }
        }
        // stage('pytest'){
        //     steps{
        //          script {
        //                 bat 'pip install pytest-html'
        //         }
        //     }
        // }
        // stage('Push front') {
        //      steps {
        //         script {
        //         // Login to Docker Hub using the credentials stored in Jenkins
        //         withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'koukaa', passwordVariable: 'nabil1234')]) {
        //             bat 'echo $DOCKER_PASSWORD | docker login -u koukaa -p nabil1234'
        //         }
        //         bat 'docker tag front koukaa/frontend:latest'
        //         bat 'docker push koukaa/frontend:latest'

        //         }
        //      }
        // }

        // stage('Push svm'){
        //     steps{
        //        script {
        //         // Login to Docker Hub using the credentials stored in Jenkins
        //         withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'hannibal', passwordVariable: 'Azerty@9911')]) {
        //             bat 'echo $DOCKER_PASSWORD | docker login -u hannibal -p Azerty@9911'
        //         }
        //         bat 'docker tag svm koukaa/svm_image:latest'
        //         bat 'docker push koukaa/svm_image:latest'
        //         } 
        //     }
        // }
        // stage('Push vgg19') {
        //      steps {
        //         script {
        //         // Login to Docker Hub using the credentials stored in Jenkins
        //         withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'koukaa', passwordVariable: 'nabil1234')]) {
        //             bat 'echo $DOCKER_PASSWORD | docker login -u koukaa -p nabil1234'
        //         }                
        //         bat 'docker tag vgg19 koukaa/vgg19_image:latest'
        //         bat 'docker push koukaa/vgg19_image:latest'
        //         }
        //      }
        // }

        
        
      
    }
    post {
    success {
        publishHTML([allowMissing: false,
                     alwaysLinkToLastBuild: true,
                     keepAll: true,
                     reportDir: 'Back_SVM',
                     reportFiles: 'report.html',
                     reportName: 'Test Report'])
    }
}

}